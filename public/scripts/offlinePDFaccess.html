<html>
  <head> 
    <style>
      body { margin:0; }
      iframe { border:none; width:100%;height:100%;position:fixed; box-sizing: border-box; display:block; opacity:0; pointer-events: none;}
      nav { width:100%;height:80px;position:fixed; box-sizing: border-box; opacity:0; pointer-events: none;top:0;left:0;
        display: flex; justify-content: center; align-items: center;
      }
      .on { opacity:1;pointer-events:auto; }
      iframe#pdf { top:80px; bottom:0;  }
    </style>
    <script src="./tree.js"></script>
    <script>

      var host = "https://library.bdrc.io"
      var params = new URLSearchParams(window.location.search);
      var h = params.get("host"); 
      if(h) host = h
      if(!host.startsWith("http")) host = "http://"+host
      var loca = host+"?useDLD=true"
      var u = params.get("url");
      if(u) {
        // don't decode or it will break 
        loca = u //decodeURIComponent(u) 
        if(!loca.includes("useDLD=")) {
          if(loca.match(/[?][^?]/)) loca +="&"
          else loca += "?"
          loca += "useDLD=true"
        }
      }
      

      // no need
      //var loca = host+"?useDLD="+encodeURIComponent(window.location.pathname.replace(/[^/]*?$/,""))
      //console.log(loca, h,params,window.location.search)
      //window.location.href = loca      
    
    </script>
  </head>
  <body>
    <iframe id="BUDA" class="on" src="https://library.bdrc.io"></iframe>    
    <nav id="top" >
      <span id="close">close</span>
    </nav>
    <iframe id="pdf" ></iframe>
    <script>
      var nav = document.querySelector("nav#top")
      var close = document.querySelector("nav#top #close")
      var pdf = document.querySelector("iframe#pdf")
      var BUDA = document.querySelector("iframe#BUDA")

      BUDA.src = loca
      
      window.addEventListener("message", async function (e) {              
        console.log("msgEv:",e);
        var data = await JSON.parse(e.data)
        console.log("data:",data,tree)
        if (data["open-viewer"]) {
          if(tree && tree[data["open-viewer"].rid] && tree[data["open-viewer"].rid].length && pdf.className != "on"){
            let vol = 0
            if(data["open-viewer"].vol) vol = data["open-viewer"].vol - 1            
            let page
            if(data["open-viewer"].page) page = data["open-viewer"].page

            let src = tree[data["open-viewer"].rid][vol] 

            // simple case: no previous pdf open, or a different version, or a different volume than before
            if(!pdf.src || !pdf.src.replace(/#page=.*?$/,"").endsWith(src)) { 
              pdf.src = src + (page?"#page="+page:"")
            } else if(page) {
              // a bit more complex if we need to update current page because changing src has no effect 
              // (see for example https://stackoverflow.com/questions/29707110/iframe-pdf-change-page-on-click-url)
              pdf.remove()
              pdf = document.createElement('iframe');
              pdf.id = "pdf"
              pdf.src = src + "#page="+page
              nav.parentNode.insertBefore(pdf, nav.nextSibling); // no insertAfter in API??
            }

            pdf.className = "on"
            BUDA.className = "off"
            nav.className = "on"



          } 
        } else if(data.url) {
          let nextURL = host + data.url.path + data.url.search;          
          let search = window.location.search.replace(/([&?])url=[^&]+/,"")
          if(search && search.match(/^[?][^?]/)) search += "&"
          else search = "?"
          search += "url="+encodeURIComponent(nextURL)
          nextURL = window.location.pathname + search

          const nextTitle = 'no title yet';
          const nextState = { };

          console.log("nextURL:"+nextURL, nextTitle)

          window.history.pushState(nextState, nextTitle, nextURL);


        }
      }, true);

      close.addEventListener("click",function(){
        nav.className = "off"
        pdf.className = "off"
        BUDA.className = "on"
      })

      // document.querySelector("iframe#pdf").src = "./data/W12827.pdf"
    </script>
  </body>
</html>